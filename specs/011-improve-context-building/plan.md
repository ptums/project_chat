# Implementation Plan: Improve Context Building with Base System Prompt

**Branch**: `011-improve-context-building` | **Date**: 2025-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-improve-context-building/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Refactor context building system to introduce a base system prompt that applies to all conversations, stored in a separate file for easy editing. Extend the system to support project-specific context extensions that append to the base prompt. Remove hardcoded system prompts from THN/DAAS code and make the architecture extensible for future project-specific system prompts and custom RAG.

## Technical Context

**Language/Version**: Python 3.10+ (existing project standard)  
**Primary Dependencies**: Existing dependencies (psycopg2-binary, python-dotenv, openai, requests)  
**Storage**: File system (for base system prompt file), PostgreSQL (for project_knowledge table)  
**Testing**: Manual testing (consistent with project standards)  
**Target Platform**: macOS/Linux (same as existing project)  
**Project Type**: Single project (CLI application with shared brain_core modules)  
**Performance Goals**: No performance impact - system prompt loading should be <10ms  
**Constraints**: Must maintain backward compatibility with existing project tags (THN, DAAS, FF, 700B, general); must preserve existing RAG functionality  
**Scale/Scope**: Support 5 project types (THN, DAAS, FF, 700B, general); extensible to future projects

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

**Status**: PASS - No constitution violations detected. This is a refactoring/improvement feature that maintains existing functionality while improving extensibility.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
brain_core/
├── base_system_prompt.txt    # NEW: Base system prompt file
├── context_builder.py        # MODIFY: Refactor to use base prompt + project extensions
├── chat.py                   # MODIFY: Update to use new context building
└── memory.py                 # EXISTING: Project knowledge retrieval (unchanged)

src/
└── [existing structure unchanged]
```

**Structure Decision**: Single project structure. New file `brain_core/base_system_prompt.txt` stores the base system prompt. Existing `context_builder.py` and `chat.py` are modified to load and compose the base prompt with project-specific extensions.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations - this is a straightforward refactoring that improves extensibility without adding complexity.

## Phase 0: Research Complete

**Status**: ✅ Complete

**Output**: `research.md` - Resolved all technical decisions:

- Base system prompt storage strategy (file-based)
- System prompt composition approach (string concatenation)
- Project-specific context format
- Context builder refactoring strategy
- Error handling approach

## Phase 1: Design Complete

**Status**: ✅ Complete

**Outputs**:

- `data-model.md` - File-based storage model, no database changes
- `contracts/api.md` - Function contracts for system prompt loading and composition
- `quickstart.md` - Setup and usage guide
- Agent context updated (`.cursor/rules/specify-rules.mdc`)

## Next Steps

**Phase 2**: Implementation tasks will be generated by `/speckit.tasks` command.

**Key Implementation Areas**:

1. Create `brain_core/base_system_prompt.txt` with base prompt content
2. Add `load_base_system_prompt()` function to `context_builder.py`
3. Add `build_project_system_prompt()` function to `context_builder.py`
4. Refactor `build_project_context()` to separate system prompt from RAG
5. Update `chat.py` to use new system prompt composition
6. Remove hardcoded prompts from THN/DAAS code paths
7. Test with all project types (THN, DAAS, FF, 700B, general)
