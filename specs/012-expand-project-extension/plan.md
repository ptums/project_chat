# Implementation Plan: Expand Project-Specific Extension with Rules

**Branch**: `012-expand-project-extension` | **Date**: 2025-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-expand-project-extension/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Expand project-specific system prompt extensions to include project-specific rules. Migrate `project_knowledge` table to simplified structure (overview + rules columns), preserve existing overview data, and update system prompt composition to include rules as a formatted bullet list.

## Technical Context

**Language/Version**: Python 3.10+ (existing project standard)  
**Primary Dependencies**: Existing dependencies (psycopg2-binary, python-dotenv)  
**Storage**: PostgreSQL (project_knowledge table migration)  
**Testing**: Manual testing (consistent with project standards)  
**Target Platform**: macOS/Linux (same as existing project)  
**Project Type**: Single project (CLI application with shared brain_core modules)  
**Performance Goals**: No performance impact - migration should complete in <1s  
**Constraints**: Must preserve existing overview data; migration must be reversible; must maintain backward compatibility during transition  
**Scale/Scope**: 5 project types (THN, DAAS, FF, 700B, general); rules column supports multi-line text

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

**Status**: PASS - No constitution violations detected. This is a database schema migration and feature extension that maintains existing functionality while adding new capabilities.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
db/
├── migrations/
│   ├── 004_project_knowledge_simplify.sql        # NEW: Migration to simplify table
│   └── 004_project_knowledge_simplify_rollback.sql # NEW: Rollback script
└── seeds/
    └── project_knowledge_seed_v2.sql             # NEW: Updated seed data with rules

brain_core/
├── context_builder.py                             # MODIFY: Update build_project_system_prompt() to include rules
└── [existing structure unchanged]
```

**Structure Decision**: Single project structure. New migration files in `db/migrations/`, updated seed data in `db/seeds/`, and modifications to `context_builder.py` to format and include rules in system prompt.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations - this is a straightforward database migration and feature extension.

## Phase 0: Research Complete

**Status**: ✅ Complete

**Output**: `research.md` - Resolved all technical decisions:

- Database migration strategy (table recreation)
- Rules column format (plain text with numbered list)
- Rules parsing and formatting approach
- Migration data preservation strategy
- System prompt format with rules section
- Seed data structure

## Phase 1: Design Complete

**Status**: ✅ Complete

**Outputs**:

- `data-model.md` - New table structure, migration path
- `contracts/api.md` - Function contracts for rules retrieval and parsing
- `quickstart.md` - Migration and usage guide
- Migration scripts created: `004_project_knowledge_simplify.sql` and rollback
- Sample seed data created: `project_knowledge_seed_v2.sql`
- Agent context updated (`.cursor/rules/specify-rules.mdc`)

## Next Steps

**Phase 2**: Implementation tasks will be generated by `/speckit.tasks` command.

**Key Implementation Areas**:

1. Implement `_get_project_rules()` function in `context_builder.py`
2. Implement `_parse_rules_text()` function in `context_builder.py`
3. Update `build_project_system_prompt()` to include rules section
4. Test migration script with existing data
5. Test system prompt with rules for all projects
